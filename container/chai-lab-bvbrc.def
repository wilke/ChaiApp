Bootstrap: docker
From: dxkb/chai-bvbrc:latest-gpu

%labels
    Author BV-BRC Team
    Application Chai-Lab
    Version 2.0.0
    Description Chai-1 molecular structure prediction with BV-BRC AppService integration
    BaseImage dxkb/dev_container:cuda12-ubuntu22.04
    License Apache-2.0

%help
    Chai-Lab BV-BRC Service Container
    ==================================

    This container provides Chai-1 molecular structure prediction
    integrated with the BV-BRC AppService framework.

    Features:
    - Chai-1 structure prediction (proteins, DNA, RNA, ligands)
    - MSA server integration
    - Template server integration
    - Experimental restraints support
    - BV-BRC workspace integration

    Usage Examples:

    # Run Chai-Lab directly
    singularity run --nv container.sif chai-lab fold input.fasta output/ --use-msa-server

    # Run as BV-BRC service
    singularity run --nv container.sif App-ChaiLab params.json

    # Interactive shell
    singularity shell --nv container.sif

    Environment:
    - GPU required (A100 80GB recommended for large complexes)
    - Model weights cached in /cache (bind mount for persistence)
    - Workspace files in /data
    - Uses standardized BV-BRC paths (/opt/patric-common/)

%environment
    # Standard BV-BRC Environment (from dxkb/dev_container)
    export RT=/opt/patric-common/runtime
    export KB_DEPLOYMENT=/opt/patric-common/deployment
    export KB_TOP=/opt/patric-common/deployment
    export PERL5LIB=$KB_DEPLOYMENT/lib:$RT/lib/perl5
    export PATH=$KB_DEPLOYMENT/bin:$RT/bin:/kb/module/scripts:$PATH

    # App-specific environment
    export KB_MODULE_DIR=/kb/module
    export IN_BVBRC_CONTAINER=1
    export CHAI_DOWNLOADS_DIR=/cache

%runscript
    case "$1" in
        App-ChaiLab*)
            shift
            exec $RT/bin/perl /kb/module/service-scripts/App-ChaiLab.pl "$@"
            ;;
        chai-lab|chai)
            shift
            exec chai-lab "$@"
            ;;
        bash|sh)
            exec /bin/bash
            ;;
        *)
            if [ -z "$1" ]; then
                echo "Chai-Lab BV-BRC Container"
                echo "Usage: singularity run --nv container.sif [command]"
                echo ""
                echo "Commands:"
                echo "  chai-lab fold <input.fasta> <output/> [options]  - Run structure prediction"
                echo "  App-ChaiLab <params.json>                        - Run as BV-BRC service"
                echo "  bash                                             - Interactive shell"
                echo ""
                echo "For help: singularity run --nv container.sif chai-lab --help"
            else
                exec "$@"
            fi
            ;;
    esac

%test
    echo "Testing Chai-Lab BV-BRC container..."

    # Test Python/Chai-Lab
    echo -n "Python: "
    python3 --version

    echo -n "Chai-Lab: "
    chai-lab --help 2>&1 | head -1 || echo "chai-lab command available"

    # Test Perl/BV-BRC (using standard path)
    echo -n "Perl: "
    /opt/patric-common/runtime/bin/perl -v | grep version | head -1

    echo -n "Perl version check: "
    /opt/patric-common/runtime/bin/perl -v | grep -q "v5.40" && echo "5.40.x OK" || echo "WARN: expected 5.40.x"

    echo -n "BV-BRC modules: "
    /opt/patric-common/runtime/bin/perl -e 'use Bio::KBase::AppService::AppScript; print "OK\n"' 2>/dev/null || echo "WARN: AppScript not fully available (expected in test)"

    # Test standard BV-BRC paths
    echo -n "BV-BRC runtime: "
    test -d /opt/patric-common/runtime && echo "OK" || echo "MISSING"

    echo -n "BV-BRC deployment: "
    test -d /opt/patric-common/deployment && echo "OK" || echo "MISSING"

    echo -n "p3 CLI tools: "
    test -f /opt/patric-common/deployment/bin/p3-login && echo "OK" || echo "MISSING"

    # Test service script exists
    echo -n "Service script: "
    test -f /kb/module/service-scripts/App-ChaiLab.pl && echo "OK" || echo "MISSING"

    # Test app specs
    echo -n "App specs: "
    test -f /kb/module/app_specs/ChaiLab.json && echo "OK" || echo "MISSING"

    # Test kalign (required for templates)
    echo -n "Kalign: "
    which kalign && echo "OK" || echo "MISSING"

    echo "Container tests completed"

%post
    echo "Chai-Lab BV-BRC container build complete"

    # Verify key components
    which chai-lab || echo "Warning: chai-lab not in PATH"
    test -f /opt/patric-common/runtime/bin/perl && echo "BV-BRC Perl: OK" || echo "Warning: BV-BRC Perl not found"

    # Create cache directory if not exists
    mkdir -p /cache

    # List BV-BRC deployment
    echo "BV-BRC deployment contents:"
    ls -la /opt/patric-common/deployment/bin/ 2>/dev/null | head -10 || echo "No deployment bin directory"

    echo "BV-BRC lib contents:"
    ls /opt/patric-common/deployment/lib/ 2>/dev/null | head -10 || echo "No deployment lib directory"
